FROM debian:latest


# 替换中科大源

RUN sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list

# 安装所需的依赖
RUN apt-get update && \
    apt-get install -y build-essential libncurses5-dev zlib1g-dev gawk git gettext wget unzip python3 && \
    rm -rf /var/lib/apt/lists/*

# 安装 Python3 distutils 模块
RUN apt-get update && apt-get install -y python3-distutils

# 安装 'file' 包
RUN apt-get update && apt-get install -y file

# 下载 OpenWrt源代码
RUN git clone https://git.openwrt.org/openwrt/openwrt.git /openwrt

# 进入 OpenWrt 源代码目录
WORKDIR /openwrt

# 配置编译环境
RUN ./scripts/feeds update -a && \
    ./scripts/feeds install -a && \
    make defconfig && \
    make menuconfig

# 编译 OpenWrt
RUN make -j$(nproc)

# 设置环境变量
ENV PATH="/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-11.2.0_musl_eabi/bin:${PATH}"

# 打包镜像
CMD ["make", "image", "PROFILE=avm_fritzbox_7530"]